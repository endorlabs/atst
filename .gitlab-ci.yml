default:
  cache: &global_cache
    - key: cache-$CI_COMMIT_REF_SLUG
      paths:
        - '.venv'  # repo-local venv used for tests and endorlabs scans

build-project:
  stage: build
  image: ubuntu:22.04
  before_script:
    - apt-get update ; apt-get install -y python3-venv python3-pip
  script:
    - python3 -m venv '.venv'
    - .venv/bin/python3 -m pip install .

endorlabs-scan:
  stage: test
  image: ubuntu:22.04
  variables:
    DEBUG: 1
    ENDOR_API_CREDENTIALS_KEY: $ENDORLABS_API_KEY
    ENDOR_API_CREDENTIALS_SECRET: $ENDORLABS_API_SECRET
    ENDOR_NAMESPACE: darren-learn
  cache:
    # use the global cache but don't updated it after scan
    <<: *global_cache
    policy: pull
  before_script:
    - apt-get update ; apt-get install -y python3-venv python3-pip
    - python3 -m venv ../.atst ; ../.atst/bin/python3 -m pip install --upgrade .
    - ../.atst/bin/endorlabs-atst setup
  script:
    - ../.atst/bin/endorctl host-check --verbose
    - ../.atst/bin/endorctl scan --ci-run --bypass-host-check --verbose